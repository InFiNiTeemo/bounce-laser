import { game } from '../core/state.js';
import { nextLevel } from '../ui/screens.js';
import { playSound } from './audio.js';

const UPGRADES=[
  {id:'maxHp',name:'\u751F\u547D\u5F3A\u5316',color:'#ff6688',desc:'\u6700\u5927HP+1 \u5E76\u6062\u590D\u6EE1\u8840',apply(){game.playerMaxHp++;game.playerHp=game.playerMaxHp;},getValue(){return `${game.playerMaxHp} \u2192 ${game.playerMaxHp+1}`;}},
  {id:'shieldCap',name:'\u62A4\u76FE\u5BB9\u91CF',color:'#00ccff',desc:'\u62A4\u76FE\u6700\u5927\u80FD\u91CF+25 \u5E76\u5145\u6EE1',apply(){game.shieldMaxEnergy+=25;game.shieldEnergy=game.shieldMaxEnergy;},getValue(){return `${game.shieldMaxEnergy} \u2192 ${game.shieldMaxEnergy+25}`;}},
  {id:'shieldRegen',name:'\u62A4\u76FE\u56DE\u590D',color:'#00eeff',desc:'\u62A4\u76FE\u6062\u590D\u901F\u5EA6+5/s',apply(){game.shieldRegenRate+=5;},getValue(){return `${game.shieldRegenRate}/s \u2192 ${game.shieldRegenRate+5}/s`;}},
  {id:'bonusAmmo',name:'\u5F39\u836F\u8865\u7ED9',color:'#44ffaa',desc:'\u7ACB\u5373\u83B7\u5F97+10\u5F39\u836F\u548C+1\u7A7F\u900F\u5F39',apply(){game.shots+=10;game.piercingCount++;},getValue(){return `\u5F39\u836F+10, \u7A7F\u900F+1`;}},
  {id:'bulletDmg',name:'\u6FC0\u5149\u5A01\u529B',color:'#ffcc44',desc:'\u5B50\u5F39\u4F24\u5BB3+1',apply(){game.bulletDamage++;},getValue(){return `${game.bulletDamage} \u2192 ${game.bulletDamage+1}`;}},
  {id:'shieldCounter',name:'\u62A4\u76FE\u53CD\u51FB',color:'#00ddff',desc:'\u62A4\u76FE\u6321\u654C\u5F39\u65F6\u53CD\u5C04\u5B50\u5F39',apply(){game.shieldCounter=true;},getValue(){return game.shieldCounter?'\u5DF2\u6FC0\u6D3B':'\u672A\u6FC0\u6D3B \u2192 \u6FC0\u6D3B';}},
  {id:'secondLife',name:'\u4E8C\u6B21\u751F\u547D',color:'#ffdd44',desc:'\u81F4\u547D\u4F24\u5BB3\u65F6\u5B58\u6D3B(\u6BCF\u5173\u4EC51\u6B21)',apply(){game.secondLife=true;},getValue(){return game.secondLife?'\u5DF2\u6FC0\u6D3B':'\u672A\u6FC0\u6D3B \u2192 \u6FC0\u6D3B';}},
  {id:'ammoRecovery',name:'\u5F39\u836F\u56DE\u6536',color:'#88ff44',desc:'\u5C04\u51FB25%\u6982\u7387\u4E0D\u6D88\u8017\u5F39\u836F',apply(){game.ammoRecoveryChance=Math.min(game.ammoRecoveryChance+0.25,0.75);},getValue(){return `${Math.round(game.ammoRecoveryChance*100)}% \u2192 ${Math.round(Math.min((game.ammoRecoveryChance+0.25)*100,75))}%`;}},
  {id:'scatter',name:'\u6563\u5C04\u5F39',color:'#44ffcc',desc:'\u6BCF\u6B21\u5C04\u51FB\u53D1\u5C04\u66F4\u591A\u5B50\u5F39(\u540C\u5F39\u836F\u6D88\u8017)',apply(){game.scatterLevel=Math.min(game.scatterLevel+1,3);},getValue(){const c=game.scatterLevel+1,n=Math.min(game.scatterLevel+2,4);return `${c}\u53D1 \u2192 ${n}\u53D1`;}},
  {id:'magnet',name:'\u78C1\u529B\u5F39',color:'#44aaff',desc:'\u5B50\u5F39\u53CD\u5F39\u540E\u81EA\u52A8\u8FFD\u8E2A\u6700\u8FD1\u7684\u654C\u4EBA',apply(){game.magnetLevel=Math.min(game.magnetLevel+1,3);},getValue(){const l=['\u65E0','\u5F31','\u4E2D','\u5F3A'];return `${l[game.magnetLevel]} \u2192 ${l[Math.min(game.magnetLevel+1,3)]}`;}},
  {id:'explosive',name:'\u7206\u88C2\u5F39\u5934',color:'#ff8844',desc:'\u5B50\u5F39\u7ED3\u675F\u65F6\u7206\u70B8, \u4F24\u5BB3\u8303\u56F4\u5185\u654C\u4EBA',apply(){game.explosiveLevel=Math.min(game.explosiveLevel+1,3);},getValue(){const r=[0,50,70,90],d=[0,1,1,2],c=game.explosiveLevel,n=Math.min(c+1,3);return c===0?`\u65E0 \u2192 R${r[n]}D${d[n]}`:`R${r[c]}D${d[c]} \u2192 R${r[n]}D${d[n]}`;}},
  {id:'chain',name:'\u8FDE\u9501\u95EA\u7535',color:'#aaccff',desc:'\u51FB\u6740\u654C\u4EBA\u65F6\u6709\u6982\u7387\u7535\u51FB\u9644\u8FD1\u654C\u4EBA',apply(){game.chainLevel=Math.min(game.chainLevel+1,3);},getValue(){const p=[0,40,60,80],c=game.chainLevel,n=Math.min(c+1,3);return c===0?`\u65E0 \u2192 ${p[n]}%\u6982\u7387`:`${p[c]}% \u2192 ${p[n]}%`;}},
  {id:'crit',name:'\u66B4\u51FB\u6982\u7387',color:'#ffdd44',desc:'\u5B50\u5F39\u6709\u6982\u7387\u9020\u6210\u53CC\u500D\u4F24\u5BB3',apply(){game.critChance=Math.min(game.critChance+0.10,0.30);},getValue(){const c=Math.round(game.critChance*100),n=Math.min(c+10,30);return `${c}% \u2192 ${n}%`;}},
  {id:'bulletLife',name:'\u5F39\u9053\u5EF6\u957F',color:'#88ffaa',desc:'\u5B50\u5F39\u5B58\u5728\u65F6\u95F4+50%',apply(){game.bulletLifeBonus+=0.5;},getValue(){return `${Math.round((1+game.bulletLifeBonus)*100)}% \u2192 ${Math.round((1.5+game.bulletLifeBonus)*100)}%`;}},
  {id:'bouncePlus',name:'\u53CD\u5F39\u5F3A\u5316',color:'#00ffcc',desc:'\u6700\u5927\u53CD\u5F39\u6B21\u6570+2',apply(){game.maxBounces+=2;},getValue(){return `${game.maxBounces}\u6B21 \u2192 ${game.maxBounces+2}\u6B21`;}},
  {id:'ammoEfficiency',name:'\u5F39\u836F\u56DE\u6536',color:'#00ff88',desc:'\u51FB\u6740\u56DE\u6536\u5F39\u836F+2',apply(){game.ammoRecoveryBonus+=2;},getValue(){return `\u57FA\u7840+${game.ammoRecoveryBonus} \u2192 \u57FA\u7840+${game.ammoRecoveryBonus+2}`;}},
  {id:'shieldArmor',name:'\u80FD\u91CF\u62A4\u7532',color:'#4488ff',desc:'\u62A4\u76FE\u6D88\u8017\u964D\u4F4E30%',apply(){game.shieldDrainMult=Math.max(0.1,game.shieldDrainMult-0.3);},getValue(){const c=Math.round(game.shieldDrainMult*100),n=Math.round(Math.max(10,(game.shieldDrainMult-0.3)*100));return `${c}% \u2192 ${n}%`;}},
  {id:'blastRadius',name:'\u8FDE\u9501\u7206\u7834',color:'#ff8844',desc:'\u7206\u70B8\u4F24\u5BB3+1, \u8303\u56F4+20%',apply(){game.explosionDmgBonus++;game.explosionRadiusMult+=0.2;},getValue(){return `\u4F24\u5BB3+${game.explosionDmgBonus+1}, \u8303\u56F4${Math.round((game.explosionRadiusMult+0.2)*100)}%`;}},
  {id:'prismBoost',name:'\u68F1\u955C\u589E\u5E45',color:'#cc66ff',desc:'\u68F1\u955C\u591A\u5206\u88C2+1\u675F, \u5206\u88C2\u5F39\u83B7\u5F97\u7A7F\u900F',apply(){game.prismSplitBonus++;game.prismPiercing=true;},getValue(){const s=`\u5206\u88C2+${game.prismSplitBonus+1}\u675F`;return game.prismPiercing?s:`${s}, \u83B7\u5F97\u7A7F\u900F`;}},
  {id:'heavyBullet',name:'\u91CD\u578B\u5F39\u5934',color:'#ff6644',desc:'\u53EF1\u51FB\u62B5\u6D88\u72D9\u51FB\u5F39, \u654C\u5F39\u97002\u51FB\u62B5\u6D88',apply(){game.heavyBullets=true;},getValue(){return game.heavyBullets?'\u5DF2\u6FC0\u6D3B':'\u672A\u6FC0\u6D3B \u2192 \u6FC0\u6D3B';}}
];

let currentUpgradeChoices=[];

export function showUpgradePanel(){const panel=document.getElementById('upgradePanel');panel.innerHTML='';const shuffled=[...UPGRADES].sort(()=>Math.random()-0.5);currentUpgradeChoices=shuffled.slice(0,3);currentUpgradeChoices.forEach((upg,idx)=>{const card=document.createElement('div');card.className='upgrade-card';card.innerHTML=`<div class="upgrade-name" style="color:${upg.color}">${upg.name}</div><div class="upgrade-value">${upg.getValue()}</div><div class="upgrade-desc">${upg.desc}</div><div class="upgrade-key">${idx+1}</div>`;card.addEventListener('click',()=>applyUpgrade(idx));panel.appendChild(card);});}

export function applyUpgrade(index){if(index<0||index>=currentUpgradeChoices.length)return;playSound('upgrade_select');currentUpgradeChoices[index].apply();currentUpgradeChoices=[];nextLevel();}
