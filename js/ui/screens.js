import { game, player, initGameState, saveGameProgress, loadGameProgress, updateContinueButton } from '../core/state.js';
import { MAX_LEVEL } from '../core/constants.js';
import { BUILTIN_LEVELS } from '../levels.js';
import { loadLevelData } from '../levelLoader.js';
import { saveHighScore, initStartDemo } from './startDemo.js';
import { getUnlockedLevel, unlockLevel } from './levelUnlock.js';
import { showUpgradePanel } from '../systems/upgrades.js';
import { getCustomLevels } from '../editor/editorStorage.js';
import { isTutorialDone, startTutorial } from '../systems/tutorial.js';
import { showIntroIfNeeded } from './introScreen.js';
import { fetchCommunityLevels } from '../community/api.js';
import { COMMUNITY_LEVELS } from '../communityLevels.js';
import { playSound, getVolume, isMuted } from '../systems/audio.js';
import { getComboStats } from '../systems/combo.js';
import { isBossAlive } from '../entities/boss.js';

/** Resolve level data: builtin by number, or custom data object */
function getLevelData(lvl) {
  if (typeof lvl === 'object') return lvl;
  return BUILTIN_LEVELS[lvl - 1] || BUILTIN_LEVELS[0];
}

export function hideAllScreens(){document.getElementById('startScreen').classList.add('hidden');document.getElementById('gameOverScreen').classList.add('hidden');document.getElementById('levelClearScreen').classList.add('hidden');document.getElementById('levelSelectScreen').classList.add('hidden');document.getElementById('bestiaryScreen').classList.add('hidden');document.getElementById('adminPanel').classList.add('hidden');document.getElementById('pauseScreen').classList.add('hidden');document.getElementById('introScreen').classList.add('hidden');game.paused=false;document.getElementById('gameContainer').classList.remove('hidden');}

export function showMainMenu(){game.running=false;hideAllScreens();document.getElementById('gameContainer').classList.add('hidden');document.getElementById('startScreen').classList.remove('hidden');initStartDemo();}

export function showGameOver(reason){game.running=false;playSound('game_over');saveHighScore();document.getElementById('deathReason').textContent=reason;const cs=getComboStats();let finalText=`\u5F97\u5206: ${game.score}`;if(cs.bestCombo>=3)finalText+=` | \u6700\u9AD8\u8FDE\u51FB: x${cs.bestCombo}`;document.getElementById('finalScore').textContent=finalText;const edBtn=document.getElementById('backToEditorBtn');if(edBtn)edBtn.classList.toggle('hidden',!game.isPlayTest);const adBtn=document.getElementById('backToAdminBtn');if(adBtn)adBtn.classList.toggle('hidden',!game.adminReview);document.getElementById('gameOverScreen').classList.remove('hidden');}

export function showLevelClear(){game.running=false;playSound('level_clear');if(game.adminReview){document.getElementById('levelScore').textContent='\u8BD5\u73A9\u901A\u8FC7!';document.getElementById('upgradePanel').innerHTML='<button class="start-btn" id="adminReviewBackBtn" style="border-color:#44ddaa;color:#44ddaa;">\u8FD4\u56DE\u5BA1\u6838</button>';document.getElementById('levelClearScreen').classList.remove('hidden');document.getElementById('adminReviewBackBtn').addEventListener('click',()=>{const{returnToAdmin}=window.__adminBridge||{};if(returnToAdmin)returnToAdmin();});return;}if(game.isPlayTest){document.getElementById('levelScore').textContent='\u8BD5\u73A9\u901A\u8FC7!';document.getElementById('upgradePanel').innerHTML='<button class="start-btn" id="playTestBackBtn" style="border-color:#aa44ff;color:#aa44ff;">\u8FD4\u56DE\u7F16\u8F91\u5668</button>';document.getElementById('levelClearScreen').classList.remove('hidden');document.getElementById('playTestBackBtn').addEventListener('click',()=>{const{returnToEditor}=window.__editorBridge||{};if(returnToEditor)returnToEditor();});return;}saveHighScore();unlockLevel(game.level+1);saveGameProgress();const cs=getComboStats();let scoreText=(game.boss||game.bossDeathSequence)?`BOSS \u51FB\u7834! \u5F97\u5206: ${game.score}`:`\u5F97\u5206: ${game.score} | \u5269\u4F59\u5F39\u836F: ${game.shots}`;if(cs.bestCombo>=3)scoreText+=` | \u8FDE\u51FB: x${cs.bestCombo}`;if(cs.comboBonus>0)scoreText+=` (+${cs.comboBonus})`;document.getElementById('levelScore').textContent=scoreText;document.getElementById('upgradePanel').innerHTML='';document.getElementById('levelClearScreen').classList.remove('hidden');requestAnimationFrame(()=>showUpgradePanel());}

export function startGame(){if(!isTutorialDone()){startTutorial();return;}initGameState(1,0,5,game.playerMaxHp);game.bulletDamage=1;game.shieldRegenRate=15;game.playerMaxHp=3;game.playerHp=3;game.shieldCounter=false;game.secondLife=false;game.ammoRecoveryChance=0;game.scatterLevel=0;game.magnetLevel=0;game.explosiveLevel=0;game.chainLevel=0;game.critChance=0;game.bulletLifeBonus=0;game.ammoRecoveryBonus=0;game.shieldDrainMult=1.0;game.explosionDmgBonus=0;game.explosionRadiusMult=1.0;game.prismSplitBonus=0;game.prismPiercing=false;game.heavyBullets=false;game.maxBounces=3;game.shieldMaxEnergy=100;const data=getLevelData(1);loadLevelData(data);hideAllScreens();showIntroIfNeeded(data,()=>{game.running=true;});}

export function continueGame(){const save=loadGameProgress();if(!save)return;game.playerMaxHp=save.playerMaxHp||3;initGameState(save.level,save.score,save.shots,save.playerHp||game.playerMaxHp);game.piercingCount=save.piercingCount||0;game.bulletDamage=save.bulletDamage||1;game.shieldRegenRate=save.shieldRegenRate||15;game.shieldCounter=save.shieldCounter||false;game.secondLife=save.secondLife||false;game.ammoRecoveryChance=save.ammoRecoveryChance||0;game.scatterLevel=save.scatterLevel||0;game.magnetLevel=save.magnetLevel||0;game.explosiveLevel=save.explosiveLevel||0;game.chainLevel=save.chainLevel||0;game.critChance=save.critChance||0;game.bulletLifeBonus=save.bulletLifeBonus||0;game.ammoRecoveryBonus=save.ammoRecoveryBonus||0;game.shieldDrainMult=save.shieldDrainMult!=null?save.shieldDrainMult:1.0;game.explosionDmgBonus=save.explosionDmgBonus||0;game.explosionRadiusMult=save.explosionRadiusMult||1.0;game.prismSplitBonus=save.prismSplitBonus||0;game.prismPiercing=save.prismPiercing||false;game.heavyBullets=save.heavyBullets||false;game.maxBounces=save.maxBounces||3;game.shieldMaxEnergy=save.shieldMaxEnergy||100;const data=getLevelData(save.level);loadLevelData(data);game.shots=save.shots;hideAllScreens();showIntroIfNeeded(data,()=>{game.running=true;});}

export function startFromLevel(lvl){initGameState(lvl,0,5+(lvl-1)*2,game.playerMaxHp);game.bulletDamage=1;game.shieldRegenRate=15;game.scatterLevel=0;game.magnetLevel=0;game.explosiveLevel=0;game.chainLevel=0;game.critChance=0;game.bulletLifeBonus=0;game.ammoRecoveryBonus=0;game.shieldDrainMult=1.0;game.explosionDmgBonus=0;game.explosionRadiusMult=1.0;game.prismSplitBonus=0;game.prismPiercing=false;game.heavyBullets=false;game.maxBounces=3;game.shieldMaxEnergy=100;const data=getLevelData(lvl);loadLevelData(data);game.shots=5+(lvl-1)*2;hideAllScreens();showIntroIfNeeded(data,()=>{game.running=true;});}

export function retryLevel(){const shots=5+(game.level-1)*2;initGameState(game.level,game.score,shots,game.playerMaxHp);const data=getLevelData(game.level);loadLevelData(data);game.shots=shots;hideAllScreens();showIntroIfNeeded(data,()=>{game.running=true;});}

export function nextLevel(){const savedShots=game.shots+1;game.level++;game.playerAlive=true;game.shieldActive=false;game.shieldEnergy=game.shieldMaxEnergy;game.shieldCooldown=false;player.invincibleTimer=1;const data=getLevelData(game.level);loadLevelData(data);game.shots=savedShots;document.getElementById('levelClearScreen').classList.add('hidden');showIntroIfNeeded(data,()=>{game.running=true;});}

/** Start a custom level (from editor play-test or custom level select) */
export function startCustomLevel(levelData){initGameState(1,0,levelData.shots||10,game.playerMaxHp);game.bulletDamage=1;game.shieldRegenRate=15;game.playerMaxHp=3;game.playerHp=3;game.scatterLevel=0;game.magnetLevel=0;game.explosiveLevel=0;game.chainLevel=0;game.critChance=0;game.bulletLifeBonus=0;game.ammoRecoveryBonus=0;game.shieldDrainMult=1.0;game.explosionDmgBonus=0;game.explosionRadiusMult=1.0;game.prismSplitBonus=0;game.prismPiercing=false;game.heavyBullets=false;game.maxBounces=3;game.shieldMaxEnergy=100;game.isPlayTest=true;game.customLevelData=levelData;loadLevelData(levelData);game.shots=levelData.shots||10;hideAllScreens();showIntroIfNeeded(levelData,()=>{game.running=true;});}

let levelPage=0;
const PER_PAGE=12;

export function buildLevelGrid(){const grid=document.getElementById('levelGrid');grid.innerHTML='';const unlocked=getUnlockedLevel();const totalPages=Math.ceil(MAX_LEVEL/PER_PAGE);const start=levelPage*PER_PAGE+1;const end=Math.min((levelPage+1)*PER_PAGE,MAX_LEVEL);
// Pagination row
const pageRow=document.createElement('div');pageRow.style.cssText='grid-column:1/-1;display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:4px;';
const prevBtn=document.createElement('button');prevBtn.className='start-btn';prevBtn.style.cssText='font-size:9px;padding:4px 12px;';prevBtn.textContent='\u25C0';prevBtn.disabled=levelPage===0;prevBtn.addEventListener('click',()=>{levelPage--;buildLevelGrid();});
const pageInfo=document.createElement('span');pageInfo.style.cssText='font-size:9px;color:#557755;';pageInfo.textContent=`${levelPage+1} / ${totalPages}`;
const nextBtn=document.createElement('button');nextBtn.className='start-btn';nextBtn.style.cssText='font-size:9px;padding:4px 12px;';nextBtn.textContent='\u25B6';nextBtn.disabled=levelPage>=totalPages-1;nextBtn.addEventListener('click',()=>{levelPage++;buildLevelGrid();});
pageRow.appendChild(prevBtn);pageRow.appendChild(pageInfo);pageRow.appendChild(nextBtn);
if(totalPages>1)grid.appendChild(pageRow);
// Level buttons for current page
for(let i=start;i<=end;i++){const btn=document.createElement('button');btn.className='level-btn';btn.textContent=i;if(i>unlocked){btn.classList.add('locked');btn.textContent='?';}else if(i<unlocked)btn.classList.add('cleared');if(i<=unlocked){const level=i;btn.addEventListener('click',function(){startFromLevel(level);});}grid.appendChild(btn);}
// Custom levels section
const customs=getCustomLevels();if(customs.length>0){const divider=document.createElement('div');divider.style.cssText='grid-column:1/-1;height:2px;background:linear-gradient(90deg,transparent,#aa44ff,transparent);margin:8px 0;';grid.appendChild(divider);const label=document.createElement('div');label.style.cssText='grid-column:1/-1;font-size:8px;color:#aa44ff;text-align:center;';label.textContent='\u81EA\u5B9A\u4E49\u5173\u5361';grid.appendChild(label);customs.forEach(cl=>{const btn=document.createElement('button');btn.className='level-btn';btn.style.cssText='border-color:#aa44ff;color:#aa44ff;font-size:8px;';btn.textContent=cl.name||'\u81EA\u5B9A\u4E49';btn.addEventListener('click',()=>startCustomLevel(cl));grid.appendChild(btn);});}
// Community levels section
const cDiv=document.createElement('div');cDiv.style.cssText='grid-column:1/-1;height:2px;background:linear-gradient(90deg,transparent,#44ddaa,transparent);margin:8px 0;';grid.appendChild(cDiv);
const cLabel=document.createElement('div');cLabel.style.cssText='grid-column:1/-1;font-size:8px;color:#44ddaa;text-align:center;display:flex;justify-content:center;align-items:center;gap:12px;';cLabel.innerHTML='\u793E\u533A\u5173\u5361 <span id="adminEntryBtn" style="font-size:6px;color:#335544;cursor:pointer;border:1px solid #223322;padding:1px 6px;">\u7BA1\u7406</span>';grid.appendChild(cLabel);
const cHolder=document.createElement('div');cHolder.id='communityLevelHolder';cHolder.style.cssText='grid-column:1/-1;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;';cHolder.innerHTML='<div style="grid-column:1/-1;font-size:9px;color:#335544;text-align:center;">\u52A0\u8F7D\u4E2D...</div>';grid.appendChild(cHolder);
loadCommunityLevels();}

function renderCommunityLevels(holder,levels){if(levels.length===0){holder.innerHTML='<div style="grid-column:1/-1;font-size:9px;color:#335544;text-align:center;">ÊöÇÊó†Á§æÂå∫ÂÖ≥Âç°</div>';return;}holder.innerHTML='';levels.forEach(entry=>{const ld=entry.levelData;const btn=document.createElement('button');btn.className='level-btn';btn.style.cssText='border-color:#44ddaa;color:#44ddaa;font-size:10px;';btn.innerHTML=`${ld.name||'Á§æÂå∫'}<br><span style="font-size:7px;color:#557755;">by ${entry.author||'ÂåøÂêç'}</span>`;btn.addEventListener('click',()=>startCustomLevel(ld));holder.appendChild(btn);});}

async function loadCommunityLevels(){const holder=document.getElementById('communityLevelHolder');if(!holder)return;try{const data=await fetchCommunityLevels();renderCommunityLevels(holder,data.levels||[]);}catch(e){if(COMMUNITY_LEVELS&&COMMUNITY_LEVELS.length>0){renderCommunityLevels(holder,COMMUNITY_LEVELS);}else{holder.innerHTML='<div style="grid-column:1/-1;font-size:9px;color:#553333;text-align:center;cursor:pointer;" id="communityRetry">Âä†ËΩΩÂ§±Ë¥•ÔºåÁÇπÂáªÈáçËØï</div>';const retry=document.getElementById('communityRetry');if(retry)retry.addEventListener('click',()=>loadCommunityLevels());}}}

export function showLevelSelect(){game.running=false;buildLevelGrid();document.getElementById('startScreen').classList.add('hidden');document.getElementById('gameContainer').classList.add('hidden');document.getElementById('levelSelectScreen').classList.remove('hidden');}

export function updateUI(){const hearts='\u2665'.repeat(game.playerHp)+'\u2661'.repeat(game.playerMaxHp-game.playerHp);const hpEl=document.getElementById('hpDisplay');hpEl.textContent=`HP: ${hearts}`;hpEl.style.color=game.playerHp<=1?'#ff4444':'#00ff88';hpEl.style.borderColor=game.playerHp<=1?'#ff4444':'#00ff88';hpEl.style.textShadow=game.playerHp<=1?'0 0 8px #ff4444':'0 0 8px #00ff88';document.getElementById('levelDisplay').textContent=`\u5173\u5361 ${game.level}`;document.getElementById('shotsDisplay').textContent=`\u5F39\u836F: ${game.shots}`;if(game.boss&&isBossAlive()){document.getElementById('enemyDisplay').textContent=`BOSS: ${game.boss.name}`;document.getElementById('enemyDisplay').style.color='#cc66ff';document.getElementById('enemyDisplay').style.borderColor='#cc66ff';document.getElementById('enemyDisplay').style.textShadow='0 0 8px #cc66ff';}else{document.getElementById('enemyDisplay').textContent=`\u654C\u4EBA: ${game.enemies.length}`;document.getElementById('enemyDisplay').style.color='';document.getElementById('enemyDisplay').style.borderColor='';document.getElementById('enemyDisplay').style.textShadow='';}const sp=Math.round(game.shieldEnergy),se=document.getElementById('shieldDisplay');se.textContent=`\u62A4\u76FE: ${sp}%`;se.style.borderColor=game.shieldCooldown?'#ff4444':'#00ccff';se.style.color=game.shieldCooldown?'#ff4444':'#00ccff';se.style.textShadow=game.shieldCooldown?'0 0 8px #ff4444':'0 0 8px #00ccff';const pe=document.getElementById('piercingDisplay');if(game.piercingCount>0){pe.style.display='';pe.textContent=`\u7A7F\u900F: ${game.piercingCount}`;pe.style.color='#ffaaff';pe.style.borderColor='#ffaaff';pe.style.textShadow='0 0 8px #ffaaff';}else pe.style.display='none';const sl=document.getElementById('secondLifeDisplay');if(game.secondLife){sl.style.display='';if(game.secondLifeUsed){sl.textContent='\u4E8C\u6B21\u751F\u547D: \u5DF2\u7528';sl.style.color='#666';sl.style.borderColor='#444';sl.style.textShadow='none';}else{sl.textContent='\u4E8C\u6B21\u751F\u547D: \u53EF\u7528';sl.style.color='#ffdd44';sl.style.borderColor='#ffdd44';sl.style.textShadow='0 0 8px #ffdd44';}}else sl.style.display='none';}

export function togglePause(){if(game.paused){game.paused=false;game.running=true;document.getElementById('pauseScreen').classList.add('hidden');document.getElementById('statusPanel').classList.add('hidden');document.getElementById('pauseHelpPanel').classList.add('hidden');document.getElementById('pauseMenu').classList.remove('hidden');return;}if(!game.running||!game.playerAlive)return;game.running=false;game.paused=true;document.getElementById('pauseScreen').classList.remove('hidden');document.getElementById('pauseMenu').classList.remove('hidden');document.getElementById('statusPanel').classList.add('hidden');document.getElementById('pauseHelpPanel').classList.add('hidden');const vs=document.getElementById('volumeSlider');if(vs){vs.value=Math.round(getVolume()*100);document.getElementById('volumeLabel').textContent=Math.round(getVolume()*100)+'%';document.getElementById('muteBtn').textContent=isMuted()?'üîá':'üîä';}}

export function showStatusPanel(){document.getElementById('pauseMenu').classList.add('hidden');const c=document.getElementById('statusContent');c.innerHTML=`<span class="stat-label">\u5173\u5361</span><span class="stat-value">${game.level}</span>`+`<span class="stat-label">\u5F97\u5206</span><span class="stat-value">${game.score}</span>`+`<span class="stat-label">\u751F\u547D</span><span class="stat-value">${game.playerHp} / ${game.playerMaxHp}</span>`+`<span class="stat-label">\u5F39\u836F</span><span class="stat-value">${game.shots}</span>`+`<span class="stat-label">\u6FC0\u5149\u5A01\u529B</span><span class="stat-value">${game.bulletDamage}</span>`+`<span class="stat-label">\u62A4\u76FE\u5BB9\u91CF</span><span class="stat-value">${game.shieldMaxEnergy}</span>`+`<span class="stat-label">\u62A4\u76FE\u56DE\u590D</span><span class="stat-value">${game.shieldRegenRate}/s</span>`+`<span class="stat-label">\u53CD\u5F39\u6B21\u6570</span><span class="stat-value">${game.maxBounces}</span>`+(game.piercingCount>0?`<span class="stat-label">\u7A7F\u900F\u5F39</span><span class="stat-value">${game.piercingCount}</span>`:'')+(game.shieldCounter?'<span class="stat-label">\u62A4\u76FE\u53CD\u51FB</span><span class="stat-value" style="color:#00ddff">\u5DF2\u6FC0\u6D3B</span>':'')+(game.secondLife?'<span class="stat-label">\u4E8C\u6B21\u751F\u547D</span><span class="stat-value" style="color:#ffdd44">'+(game.secondLifeUsed?'\u5DF2\u4F7F\u7528':'\u53EF\u7528')+'</span>':'')+(game.ammoRecoveryChance>0?`<span class="stat-label">\u5F39\u836F\u56DE\u6536</span><span class="stat-value" style="color:#88ff44">${Math.round(game.ammoRecoveryChance*100)}%</span>`:'')+(game.scatterLevel>0?`<span class="stat-label">\u6563\u5C04\u5F39</span><span class="stat-value" style="color:#44ffcc">${game.scatterLevel+1}\u53D1</span>`:'')+(game.magnetLevel>0?`<span class="stat-label">\u78C1\u529B\u5F39</span><span class="stat-value" style="color:#44aaff">${['\u5F31','\u4E2D','\u5F3A'][game.magnetLevel-1]}</span>`:'')+(game.explosiveLevel>0?`<span class="stat-label">\u7206\u88C2\u5F39\u5934</span><span class="stat-value" style="color:#ff8844">Lv${game.explosiveLevel}</span>`:'')+(game.chainLevel>0?`<span class="stat-label">\u8FDE\u9501\u95EA\u7535</span><span class="stat-value" style="color:#aaccff">${[40,60,80][game.chainLevel-1]}%</span>`:'')+(game.critChance>0?`<span class="stat-label">\u66B4\u51FB\u6982\u7387</span><span class="stat-value" style="color:#ffdd44">${Math.round(game.critChance*100)}%</span>`:'')+(game.bulletLifeBonus>0?`<span class="stat-label">\u5F39\u9053\u5EF6\u957F</span><span class="stat-value" style="color:#88ffaa">${Math.round((1+game.bulletLifeBonus)*100)}%</span>`:'')+(game.ammoRecoveryBonus>0?`<span class="stat-label">\u51FB\u6740\u56DE\u6536</span><span class="stat-value" style="color:#00ff88">+${game.ammoRecoveryBonus}</span>`:'')+(game.shieldDrainMult<1?`<span class="stat-label">\u80FD\u91CF\u62A4\u7532</span><span class="stat-value" style="color:#4488ff">${Math.round(game.shieldDrainMult*100)}%\u6D88\u8017</span>`:'')+(game.explosionDmgBonus>0?`<span class="stat-label">\u7206\u70B8\u52A0\u6210</span><span class="stat-value" style="color:#ff8844">+${game.explosionDmgBonus}\u4F24\u5BB3 ${Math.round(game.explosionRadiusMult*100)}%\u8303\u56F4</span>`:'')+(game.prismSplitBonus>0?`<span class="stat-label">\u68F1\u955C\u589E\u5E45</span><span class="stat-value" style="color:#cc66ff">+${game.prismSplitBonus}\u675F${game.prismPiercing?' \u7A7F\u900F':''}</span>`:'');document.getElementById('statusPanel').classList.remove('hidden');}

export function hideStatusPanel(){document.getElementById('statusPanel').classList.add('hidden');document.getElementById('pauseMenu').classList.remove('hidden');}

export function showPauseHelp(){document.getElementById('pauseMenu').classList.add('hidden');document.getElementById('pauseHelpPanel').classList.remove('hidden');}

export function hidePauseHelp(){document.getElementById('pauseHelpPanel').classList.add('hidden');document.getElementById('pauseMenu').classList.remove('hidden');}
